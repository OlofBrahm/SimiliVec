FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copy solution and project files
COPY ["VectorDataBase.sln", "./"]
COPY ["SimiliVec.Api/SimiliVec.Api.csproj", "SimiliVec.Api/"]
COPY ["VectorDataBase/VectorDataBase.csproj", "VectorDataBase/"]

# Restore dependencies
RUN dotnet restore "SimiliVec.Api/SimiliVec.Api.csproj"

# Copy source code
COPY . .

# Download ML models during build
WORKDIR /src
RUN apt-get update && apt-get install -y curl
RUN mkdir -p VectorDataBase/MLModels/e5-small-v2
RUN curl -L -o VectorDataBase/MLModels/e5-small-v2/model.onnx \
    https://huggingface.co/intfloat/e5-small-v2/resolve/main/model.onnx
RUN curl -L -o VectorDataBase/MLModels/e5-small-v2/vocab.txt \
    https://huggingface.co/intfloat/e5-small-v2/resolve/main/vocab.txt
RUN curl -L -o VectorDataBase/MLModels/e5-small-v2/tokenizer.json \
    https://huggingface.co/intfloat/e5-small-v2/resolve/main/tokenizer.json
RUN curl -L -o VectorDataBase/MLModels/e5-small-v2/tokenizer_config.json \
    https://huggingface.co/intfloat/e5-small-v2/resolve/main/tokenizer_config.json

# Build the application
WORKDIR /src/SimiliVec.Api
RUN dotnet build "SimiliVec.Api.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "SimiliVec.Api.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "SimiliVec.Api.dll"]