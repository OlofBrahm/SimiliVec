<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SimiliVec HNSW Test Bench</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
    <style>
        body { background: #121212; color: white; }
        #canvas-container { width: 100%; height: 500px; background: #000; border-radius: 8px; position: relative; }
        .sidebar { height: 100vh; overflow-y: auto; border-right: 1px solid #333; padding: 20px; }
        .card { background: #1e1e1e; color: white; border: 1px solid #333; margin-bottom: 10px; }
        .node-count { position: absolute; top: 10; right: 10; z-index: 10; background: rgba(0,0,0,0.5); padding: 5px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-4 sidebar">
            <h3>SimiliVec 3D</h3>
            <hr>
            
            <button onclick="fetchInitialMap()" class="btn btn-primary w-100 mb-3">1. Load Global Map</button>
            
            <div class="input-group mb-3">
                <input id="queryInput" type="text" class="form-control" placeholder="Search vectors...">
                <button onclick="performSearch()" class="btn btn-success">Search</button>
            </div>

            <div id="resultsList">
                <p class="text-muted">Search results will appear here...</p>
            </div>
        </div>

        <div class="col-md-8 p-4">
            <div id="canvas-container">
                <div class="node-count">Nodes: <span id="count">0</span></div>
            </div>
            <div class="mt-3">
                <h5>3D Navigation</h5>
                <p class="small text-muted">Left Click: Rotate | Scroll: Zoom | Right Click: Pan</p>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:5202/api/vector"; // Update to your API URL
    let scene, camera, renderer, points, queryMarker;
    let nodeObjects = {};

    // --- 3D SETUP ---
    function init3D() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / 500, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(document.getElementById('canvas-container').clientWidth, 500);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        
        camera.position.z = 5;
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (points) points.rotation.y += 0.001;
        renderer.render(scene, camera);
    }

    // --- API CALLS ---

    // 1. Fetch all nodes for the 3D cloud
    async function fetchInitialMap() {
        try {
            // Adjust endpoint if necessary
            const response = await fetch(`${API_URL}/nodes`); 
            const nodes = await response.json(); // Dictionary<int, PCANode>
            
            renderPointCloud(Object.values(nodes));
            document.getElementById('count').innerText = Object.keys(nodes).length;
        } catch (e) { console.error("Map Load Failed", e); }
    }

    // 2. Perform Vector Search
    async function performSearch() {
        const query = document.getElementById('queryInput').value;
        const k = 5;

        try {
            const response = await fetch(`${API_URL}/search?k=${k}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(query)
            });
            const data = await response.json(); // SearchResponse

            displayResults(data.documents);
            highlightSearchIn3D(data.queryPosition, data.resultNodeIds);
        } catch (e) { console.error("Search Failed", e); }
    }

    // --- RENDERING LOGIC ---

    function renderPointCloud(nodes) {
        if(points) scene.remove(points);

        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];

        nodes.forEach(node => {
            positions.push(node.reducedVector[0], node.reducedVector[1], node.reducedVector[2]);
            colors.push(0, 0.5, 1); // Default Blue
        });

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({ size: 0.05, vertexColors: true });
        points = new THREE.Points(geometry, material);
        scene.add(points);
    }

    function highlightSearchIn3D(queryPos, hitIds) {
        // Remove old marker
        if(queryMarker) scene.remove(queryMarker);

        // Add Red Sphere at Search Landing Point
        const geo = new THREE.SphereGeometry(0.1);
        const mat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        queryMarker = new THREE.Mesh(geo, mat);
        queryMarker.position.set(queryPos[0], queryPos[1], queryPos[2]);
        scene.add(queryMarker);

        // Move camera to look at the landing point
        camera.position.set(queryPos[0], queryPos[1], queryPos[2] + 3);
    }

    function displayResults(docs) {
        const container = document.getElementById('resultsList');
        container.innerHTML = docs.map(doc => `
            <div class="card p-3">
                <strong>Doc ID: ${doc.id}</strong>
                <p class="small mb-0">${doc.content.substring(0, 100)}...</p>
                <span class="badge bg-info mt-2">Similarity Score: ${doc.distance?.toFixed(4) || 'N/A'}</span>
            </div>
        `).join('');
    }

    window.onload = init3D;
</script>
</body>
</html>